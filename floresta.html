<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Quest - Floresta em Chamas</title>
    <link rel="icon" type="image/png" href="images/flavicon.png">
    <style>
        /* O CSS permanece o mesmo at√© aqui */
        :root {
            --primary: #1A5D1A; --primary-hover: #144514; --secondary: #F5F5F5;
            --white: #FFFFFF; --text-primary: #212121; --text-secondary: #555555;
            --border: #E0E0E0; --danger: #D32F2F;
            --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px;
            --font-primary: 'Segoe UI', Roboto, sans-serif; --font-size-sm: 14px;
            --font-size-base: 16px; --font-size-lg: 20px; --font-size-xl: 28px;
            --line-height-base: 1.6; --radius-md: 8px; --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --transition-base: 0.3s ease;
        }

        body.light-theme {
            --bg-main: #F5F5F5; --bg-panel: rgba(255, 255, 255, 0.25);
            --bg-panel-hover: rgba(255, 255, 255, 0.4); --bg-menu: rgba(255, 255, 255, 0.7);
            --text-main: #212121; --text-panel: #FFFFFF; --text-menu: #212121;
            --border-color: rgba(255, 255, 255, 0.3); --shadow-text: 1px 1px 3px rgba(0,0,0,0.5);
        }

        body.dark-theme {
            --primary: #4CAF50; --primary-hover: #388E3C; --bg-main: #121212;
            --bg-panel: rgba(18, 18, 18, 0.6); --bg-panel-hover: rgba(18, 18, 18, 0.8);
            --bg-menu: rgba(30, 30, 30, 0.8); --text-main: #FFFFFF; --text-panel: #FFFFFF;
            --text-menu: #FFFFFF; --border-color: rgba(255, 255, 255, 0.2); --shadow-text: none;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-primary); font-size: var(--font-size-base);
            line-height: var(--line-height-base); color: var(--text-main);
            background-color: var(--bg-main); overflow: hidden;
            transition: background-color var(--transition-base), color var(--transition-base);
        }

        .game-viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        .hero-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; transition: opacity 1.5s ease-in-out; }
        .game-content-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 2; display: flex; justify-content: center; align-items: center; padding: var(--space-lg); opacity: 0; transition: opacity 1s ease; }

        .game-title { position: absolute; top: var(--space-lg); left: 50%; transform: translateX(-50%); z-index: 1001; width: 300px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
        .menu-toggle { position: absolute; top: var(--space-lg); left: var(--space-lg); width: 50px; height: 50px; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; cursor: pointer; z-index: 1002; box-shadow: var(--shadow-md); backdrop-filter: blur(8px); }
        .menu-toggle .bar { width: 24px; height: 3px; background: var(--text-panel); border-radius: 2px; transition: all var(--transition-base); }
        .menu-toggle.open .bar { background: var(--text-menu); }
        .menu-toggle.open .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
        .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.open .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

        .floating-menu { position: fixed; top: 0; left: -350px; width: 350px; height: 100vh; background: var(--bg-menu); backdrop-filter: blur(15px); padding: var(--space-lg); padding-top: 80px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 1001; transition: left var(--transition-base); box-shadow: var(--shadow-md); color: var(--text-menu); }
        .floating-menu.open { left: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-base), visibility var(--transition-base); }
        .menu-overlay.open { opacity: 1; visibility: visible; }

        .sidebar-section { background: rgba(0,0,0,0.05); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); }
        .sidebar-title { font-size: var(--font-size-lg); font-weight: 600; color: var(--primary); margin-bottom: var(--space-md); cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-title::after { content: '‚ñº'; font-size: 12px; transition: transform var(--transition-base); }
        .sidebar-title.collapsed::after { transform: rotate(-90deg); }
        .collapsible-content { max-height: 500px; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease; }
        .collapsible-content.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: -16px; }
        #context-display, #actions-log { font-size: var(--font-size-sm); max-height: 200px; overflow-y: auto; }
        #actions-log ul { list-style-position: inside; padding-left: var(--space-sm); }
        .btn.theme-switcher-btn, .btn.home-btn { margin-top: auto; background: none; border: 1px solid var(--text-menu); color: var(--text-menu); }
        .btn.home-btn { margin-top: var(--space-md); }

        .interaction-panel { max-width: 900px; width: 90%; background: var(--bg-panel); padding: var(--space-xl); border-radius: var(--radius-md); box-shadow: var(--shadow-md); border: 1px solid var(--border-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        #cutscene-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: flex; justify-content: center; align-items: flex-end; background-color: #000; }
        #cutscene-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.5s ease-in-out; }
        #cutscene-caption { position: relative; z-index: 2001; background: rgba(0,0,0,0.7); color: white; padding: var(--space-lg); margin-bottom: 10%; max-width: 700px; width: 80%; border-radius: var(--radius-md); text-align: center; font-size: var(--font-size-lg); opacity: 0; transition: opacity 1s ease-in-out; }

        #game-screen { display: flex; flex-direction: column; height: 80vh; max-height: 700px; }
        #chat-history { flex-grow: 1; overflow-y: auto; padding: var(--space-md); margin-bottom: var(--space-md); display: flex; flex-direction: column; gap: var(--space-md); }
        .chat-message { max-width: 85%; padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); line-height: 1.5; color: var(--text-panel); text-shadow: var(--shadow-text); }
        .chat-message.agent { background: rgba(0,0,0,0.2); align-self: flex-start; }
        .chat-message.player { background: var(--primary); color: var(--white); align-self: flex-end; text-shadow: none; }
        .chat-message.system { color: #ccc; font-style: italic; text-align: center; background: none; }

        /* NOVO: Estilo para mensagem de cooldown */
        .chat-message.cooldown {
            color: #ffa726;
            font-style: italic;
            text-align: center;
            background: rgba(255, 167, 38, 0.1);
            font-size: var(--font-size-sm);
        }

        .chat-input-area { display: flex; gap: var(--space-md); }
        #user-input { flex-grow: 1; padding: var(--space-md); border: 1px solid var(--border-color); border-radius: var(--radius-md); background: rgba(0, 0, 0, 0.2); color: var(--text-panel); resize: none; }
        #user-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .btn { padding: 12px 24px; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: 600; cursor: pointer; transition: all var(--transition-base); }
        .btn-primary { background: var(--primary); color: var(--white); text-align: center; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-primary:disabled { background: #999; cursor: not-allowed; transform: none; }
        .btn-choice { background: var(--bg-panel); color: var(--text-panel); border: 1px solid var(--border-color); backdrop-filter: blur(5px); text-align: center; padding: 8px 16px; font-size: var(--font-size-sm); }
        .btn-choice:hover { background: var(--bg-panel-hover); border-color: var(--primary); }
        .btn-choice:disabled { opacity: 0.5; cursor: not-allowed; }
        .choices-container { display: flex; flex-wrap: wrap; gap: var(--space-md); justify-content: center; margin-top: var(--space-md); }

        .page-footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            font-size: 12px;
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border-radius: var(--radius-md);
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }
        .page-footer a { color: #fff; text-decoration: none; font-weight: 600; }
        .page-footer a:hover { text-decoration: underline; }
        body.light-theme .page-footer {
            background-color: rgba(255, 255, 255, 0.25);
            color: rgba(0,0,0,0.7);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        body.light-theme .page-footer a { color: #000; }

        @media (max-width: 768px) {
            .game-title { width: 200px; top: var(--space-md); }
            .interaction-panel { width: 95%; padding: var(--space-lg); }
            .floating-menu { width: 280px; left: -280px; }
            #cutscene-caption { font-size: var(--font-size-base); margin-bottom: 20%; }
        }
    </style>
</head>
<body class="light-theme">

    <div class="game-viewport">
        <img src="images/floresta/fundo/3.png" alt="Cen√°rio de fundo do Eco Quest" class="hero-background" id="main-hero-background">
        <img src="images/titulo.png" alt="Eco Quest" class="game-title">

        <div class="game-content-overlay">
            <div id="game-screen" class="interaction-panel">
                <div id="chat-history"></div>
                <div id="choices-container" class="choices-container"></div>
                <div class="chat-input-area">
                    <textarea id="user-input" placeholder="Descreva sua a√ß√£o..." rows="1"></textarea>
                    <button id="send-btn" class="btn btn-primary">Enviar</button>
                </div>
            </div>
        </div>

        <div id="cutscene-screen">
            <img id="cutscene-image" src="images/floresta/4.png" alt="Cena de introdu√ß√£o">
            <p id="cutscene-caption"></p>
        </div>

        <div class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
        <div class="menu-overlay" id="menu-overlay"></div>
        <aside class="floating-menu" id="floating-menu">
            <div class="sidebar-section">
                <h2 class="sidebar-title">üåç Contexto</h2>
                <div class="collapsible-content">
                    <div id="context-display"><p>Aguardando...</p></div>
                </div>
            </div>
            <div class="sidebar-section">
                <h2 class="sidebar-title">üìù A√ß√µes</h2>
                <div class="collapsible-content">
                    <div id="actions-log"><ul></ul></div>
                </div>
            </div>
            <div class="sidebar-section">
                <h2 class="sidebar-title">üèÜ Progresso</h2>
                <div class="collapsible-content">
                    <div id="progress-display"><p>0%</p></div>
                </div>
            </div>

            <button class="btn home-btn" id="home-btn">üè† Voltar ao In√≠cio</button>
            <button class="btn theme-switcher-btn" id="theme-switcher">‚òÄÔ∏è/üåô Tema</button>
        </aside>
    </div>

    <footer class="page-footer">
        Desenvolvido por <a href="https://www.linkedin.com/in/laredo-nunes-0a8a7363" target="_blank">Laredo Nunes</a> |
        <a href="https://github.com/laredonunes/ecoquest_api" target="_blank">Reposit√≥rio</a> |
        <a href="mailto:laredonunes@gmail.com">Contato</a>
    </footer>

    <script src="js/config.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS ---
        const allDOMElements = {
            cutsceneScreen: document.getElementById('cutscene-screen'),
            cutsceneImage: document.getElementById('cutscene-image'),
            cutsceneCaption: document.getElementById('cutscene-caption'),
            mainHeroBackground: document.getElementById('main-hero-background'),
            gameContentOverlay: document.querySelector('.game-content-overlay'),
            chatHistory: document.getElementById('chat-history'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            choicesContainer: document.getElementById('choices-container'),
            contextDisplay: document.getElementById('context-display'),
            actionsLog: document.getElementById('actions-log').querySelector('ul'),
            progressDisplay: document.getElementById('progress-display'),
            menuToggle: document.getElementById('menu-toggle'),
            floatingMenu: document.getElementById('floating-menu'),
            menuOverlay: document.getElementById('menu-overlay'),
            themeSwitcher: document.getElementById('theme-switcher'),
            homeBtn: document.getElementById('home-btn'),
            body: document.body
        };

        // --- GAME STATE ---
        const gameState = {
            isWaitingForResponse: false,
            backendGameState: null,
            lastRequestTime: 0,          // NOVO: timestamp da √∫ltima requisi√ß√£o
            cooldownSeconds: 3            // NOVO: tempo de cooldown em segundos
        };

        // --- NOVO: FUN√á√ÉO DE COOLDOWN ---
        function checkCooldown() {
            const now = Date.now();
            const timeSinceLastRequest = (now - gameState.lastRequestTime) / 1000; // em segundos

            if (timeSinceLastRequest < gameState.cooldownSeconds) {
                const remainingTime = Math.ceil(gameState.cooldownSeconds - timeSinceLastRequest);
                return {
                    allowed: false,
                    remainingTime: remainingTime
                };
            }

            return { allowed: true };
        }

        function updateLastRequestTime() {
            gameState.lastRequestTime = Date.now();
        }

        // --- L√ìGICA DO MENU E TEMA ---
        function toggleMenu() {
            allDOMElements.menuToggle.classList.toggle('open');
            allDOMElements.floatingMenu.classList.toggle('open');
            allDOMElements.menuOverlay.classList.toggle('open');
        }

        function setTheme(theme) {
            allDOMElements.body.classList.remove('light-theme', 'dark-theme');
            allDOMElements.body.classList.add(theme + '-theme');
            localStorage.setItem('theme', theme);
        }

        allDOMElements.menuToggle.addEventListener('click', toggleMenu);
        allDOMElements.menuOverlay.addEventListener('click', toggleMenu);

        allDOMElements.themeSwitcher.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });

        allDOMElements.homeBtn.addEventListener('click', () => {
            window.location.href = '/index.html';
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // --- L√ìGICA DO MENU COLAPS√ÅVEL ---
        document.querySelectorAll('.sidebar-title').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            });
        });

        // --- API & UI FUNCTIONS ---
        async function postData(url = '', data = {}) {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const text = await response.text();
            let json;
            try {
                json = JSON.parse(text);
            } catch (e) {
                throw new Error(`Resposta inv√°lida da API: ${text.slice(0, 200)}...`);
            }
            if (!response.ok || json.status === 'error') {
                const msg = json.error || response.statusText;
                throw new Error(msg);
            }
            return json;
        }

        function addMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', sender);
            messageEl.innerHTML = `<p>${text}</p>`;
            allDOMElements.chatHistory.appendChild(messageEl);
            allDOMElements.chatHistory.scrollTop = allDOMElements.chatHistory.scrollHeight;
        }

        function setInputDisabled(disabled) {
            gameState.isWaitingForResponse = disabled;
            allDOMElements.userInput.disabled = disabled;
            allDOMElements.sendBtn.disabled = disabled;

            // MODIFICADO: desabilita visualmente os bot√µes de escolha
            const choiceButtons = allDOMElements.choicesContainer.querySelectorAll('.btn-choice');
            choiceButtons.forEach(btn => btn.disabled = disabled);

            allDOMElements.userInput.placeholder = disabled
                ? 'Aguardando resposta do agente...'
                : 'Descreva sua a√ß√£o...';
        }

        function renderChoices(options) {
            allDOMElements.choicesContainer.innerHTML = '';
            if (!Array.isArray(options)) return;
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.classList.add('btn', 'btn-choice');
                btn.textContent = option;
                btn.addEventListener('click', () => {
                    // MODIFICADO: verifica cooldown antes de processar clique
                    const cooldownCheck = checkCooldown();
                    if (!cooldownCheck.allowed) {
                        addMessage(
                            `‚è≥ Aguarde ${cooldownCheck.remainingTime}s antes de fazer outra a√ß√£o.`,
                            'cooldown'
                        );
                        return;
                    }

                    addMessage(option, 'player');
                    sendPlayerDecision(option);
                });
                allDOMElements.choicesContainer.appendChild(btn);
            });
        }

        function logAction(text) {
            const li = document.createElement('li');
            li.textContent = text;
            allDOMElements.actionsLog.appendChild(li);
        }

        function updateBackgroundImage(dangerMeter) {
            let imageName = '3.png';
            if (dangerMeter >= 90) {
                imageName = '8.png';
            } else if (dangerMeter >= 70) {
                imageName = '7.png';
            } else if (dangerMeter >= 50) {
                imageName = '6.png';
            } else if (dangerMeter >= 30) {
                imageName = '5.png';
            }

            const newImageUrl = `images/floresta/fundo/${imageName}`;

            if (allDOMElements.mainHeroBackground.src.endsWith(newImageUrl)) return;

            allDOMElements.mainHeroBackground.style.opacity = 0;
            setTimeout(() => {
                allDOMElements.mainHeroBackground.src = newImageUrl;
                allDOMElements.mainHeroBackground.style.opacity = 1;
            }, 500);
        }

        function updateUI(response) {
            const { narrative, game_state } = response;

            addMessage(narrative.panel_description, 'agent');
            renderChoices(narrative.inner_voice_options);

            gameState.backendGameState = game_state;

            const chapter = response.chapter || 'Investiga√ß√£o em curso';
            const op = response.operation || 'Opera√ß√£o desconhecida';
            const progress = response.progress || '';

            allDOMElements.contextDisplay.innerHTML = `
                <p><strong>${op}</strong></p>
                <p>${chapter}</p>
                <p style="margin-top:8px;">${narrative.narrative_hint || ''}</p>
            `;

            allDOMElements.progressDisplay.innerHTML = `
                <p>${progress}</p>
                <p>Perigo: ${(narrative.danger_level || '').toUpperCase()}</p>
            `;

            updateBackgroundImage(game_state.danger_meter);
        }

        // --- CHAMADAS √Ä API /api/floresta ---
        async function startGame() {
            try {
                setInputDisabled(true);
                addMessage('Iniciando Opera√ß√£o Cinzas da Floresta...', 'system');

                updateLastRequestTime(); // NOVO: registra timestamp

                const response = await postData('/api/floresta', { action: 'start' });
                updateUI(response);
                setInputDisabled(false);
            } catch (error) {
                addMessage(`Erro ao iniciar a hist√≥ria: ${error.message}`, 'system');
                setInputDisabled(false);
            }
        }

        async function sendPlayerDecision(playerText) {
            // NOVO: verifica se j√° est√° processando ou em cooldown
            if (gameState.isWaitingForResponse) return;

            const cooldownCheck = checkCooldown();
            if (!cooldownCheck.allowed) {
                addMessage(
                    `‚è≥ Aguarde ${cooldownCheck.remainingTime}s antes de fazer outra a√ß√£o.`,
                    'cooldown'
                );
                return;
            }

            setInputDisabled(true);
            allDOMElements.choicesContainer.innerHTML = '';
            logAction(playerText);

            try {
                updateLastRequestTime(); // NOVO: registra timestamp

                const payload = {
                    action: 'continue',
                    player_decision: playerText,
                    game_state: gameState.backendGameState || {}
                };
                const response = await postData('/api/floresta', payload);
                updateUI(response);
                setInputDisabled(false);
            } catch (error) {
                addMessage(`Erro ao continuar a hist√≥ria: ${error.message}`, 'system');
                setInputDisabled(false);
            }
        }

        async function sendInteractionFromInput() {
            const text = allDOMElements.userInput.value.trim();
            if (!text) return;

            // NOVO: verifica cooldown antes de processar
            const cooldownCheck = checkCooldown();
            if (!cooldownCheck.allowed) {
                addMessage(
                    `‚è≥ Aguarde ${cooldownCheck.remainingTime}s antes de fazer outra a√ß√£o.`,
                    'cooldown'
                );
                return;
            }

            addMessage(text, 'player');
            allDOMElements.userInput.value = '';
            await sendPlayerDecision(text);
        }

        // --- INITIALIZATION ---
        function setupEventListeners() {
            allDOMElements.sendBtn.addEventListener('click', () => {
                sendInteractionFromInput();
            });
            allDOMElements.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendInteractionFromInput();
                }
            });
        }

        function playForestCutscene() {
            allDOMElements.cutsceneScreen.style.display = 'flex';
            const scenes = [
                { img: 'images/floresta/4.png', text: 'Em uma floresta de Mata Atl√¢ntica, lar de animais, plantas e homens, a vida que s√≥ beneficia est√° em amea√ßa.' },
                { img: 'images/floresta/5.png', text: 'O fogo, que √†s vezes serve para renovar, agora chega de maneira inexplic√°vel, cumprindo s√≥ seu objetivo de destruir.' },
                { img: 'images/floresta/3.png', text: 'Agora, eu chego para buscar a solu√ß√£o, para manter a vida e traz√™-la de volta aqui.' },
                { img: 'images/floresta/3.png', text: 'Sou um agente ambiental, e voc√™ que est√° comigo √© a intelig√™ncia que vai me orientar a buscar solu√ß√µes para esta floresta devastada.' }
            ];

            function showScene(sceneIndex) {
                if (sceneIndex >= scenes.length) {
                    allDOMElements.cutsceneScreen.style.opacity = 0;
                    setTimeout(async () => {
                        allDOMElements.cutsceneScreen.style.display = 'none';
                        allDOMElements.gameContentOverlay.style.opacity = 1;
                        await startGame();
                    }, 1000);
                    return;
                }
                const scene = scenes[sceneIndex];
                allDOMElements.cutsceneCaption.style.opacity = 0;
                allDOMElements.cutsceneImage.style.opacity = 0;
                setTimeout(() => {
                    allDOMElements.cutsceneImage.src = scene.img;
                    allDOMElements.cutsceneCaption.textContent = scene.text;
                    allDOMElements.cutsceneImage.style.opacity = 1;
                    allDOMElements.cutsceneCaption.style.opacity = 1;
                    setTimeout(() => showScene(sceneIndex + 1), 5000);
                }, 1000);
            }
            showScene(0);
        }

        setupEventListeners();
        playForestCutscene();
    });
    </script>
</body>
</html>